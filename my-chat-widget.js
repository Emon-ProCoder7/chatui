// Chat Widget Script (Modified for Initial Message, Avatars, and Custom Icon)
(function() {
    const styles = `.n8n-chat-widget{--chat--color-primary:var(--n8n-chat-primary-color,#854fff);--chat--color-secondary:var(--n8n-chat-secondary-color,#6b3fd4);--chat--color-background:var(--n8n-chat-background-color,#fff);--chat--color-font:var(--n8n-chat-font-color,#333);font-family:'Geist Sans',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif}.n8n-chat-widget .chat-container{position:fixed;bottom:20px;right:20px;z-index:1000;display:none;width:380px;height:600px;background:var(--chat--color-background);border-radius:12px;box-shadow:0 8px 32px rgba(133,79,255,.15);border:1px solid rgba(133,79,255,.2);overflow:hidden;font-family:inherit}.n8n-chat-widget .chat-container.position-left{right:auto;left:20px}.n8n-chat-widget .chat-container.open{display:flex;flex-direction:column}.n8n-chat-widget .brand-header{padding:16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(133,79,255,.1);position:relative}.n8n-chat-widget .close-button{position:absolute;right:16px;top:50%;transform:translateY(-50%);background:0 0;border:none;color:var(--chat--color-font);cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;transition:color .2s;font-size:20px;opacity:.6}.n8n-chat-widget .close-button:hover{opacity:1}.n8n-chat-widget .brand-header img{width:32px;height:32px}.n8n-chat-widget .brand-header span{font-size:18px;font-weight:500;color:var(--chat--color-font)}.n8n-chat-widget .new-conversation{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px;text-align:center;width:100%;max-width:300px}.n8n-chat-widget .welcome-text{font-size:24px;font-weight:600;color:var(--chat--color-font);margin-bottom:24px;line-height:1.3}.n8n-chat-widget .new-chat-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:16px 24px;background:linear-gradient(135deg,var(--chat--color-primary) 0,var(--chat--color-secondary) 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:16px;transition:transform .3s;font-weight:500;font-family:inherit;margin-bottom:12px}.n8n-chat-widget .new-chat-btn:hover{transform:scale(1.02)}.n8n-chat-widget .message-icon{width:20px;height:20px}.n8n-chat-widget .response-text{font-size:14px;color:var(--chat--color-font);opacity:.7;margin:0}.n8n-chat-widget .chat-interface{display:none;flex-direction:column;height:100%}.n8n-chat-widget .chat-interface.active{display:flex}.n8n-chat-widget .chat-messages{flex:1;overflow-y:auto;padding:20px;background:var(--chat--color-background);display:flex;flex-direction:column;gap:8px}.n8n-chat-widget .chat-message{padding:12px 16px;border-radius:12px;max-width:100%;word-wrap:break-word;font-size:14px;line-height:1.5}.n8n-chat-widget .chat-message.user{background:linear-gradient(135deg,var(--chat--color-primary) 0,var(--chat--color-secondary) 100%);color:#fff;box-shadow:0 4px 12px rgba(133,79,255,.2);border:none}.n8n-chat-widget .chat-message.bot{background:var(--chat--color-background);border:1px solid rgba(133,79,255,.2);color:var(--chat--color-font);box-shadow:0 4px 12px rgba(0,0,0,.05)}.n8n-chat-widget .chat-input{padding:16px;background:var(--chat--color-background);border-top:1px solid rgba(133,79,255,.1);display:flex;gap:8px}.n8n-chat-widget .chat-input textarea{flex:1;padding:12px;border:1px solid rgba(133,79,255,.2);border-radius:8px;background:var(--chat--color-background);color:var(--chat--color-font);resize:none;font-family:inherit;font-size:14px}.n8n-chat-widget .chat-input textarea::placeholder{color:var(--chat--color-font);opacity:.6}.n8n-chat-widget .chat-input button{background:linear-gradient(135deg,var(--chat--color-primary) 0,var(--chat--color-secondary) 100%);color:#fff;border:none;border-radius:8px;padding:0 20px;cursor:pointer;transition:transform .2s;font-family:inherit;font-weight:500}.n8n-chat-widget .chat-input button:hover{transform:scale(1.05)}.n8n-chat-widget .chat-toggle{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:30px;background:linear-gradient(135deg,var(--chat--color-primary) 0,var(--chat--color-secondary) 100%);color:#fff;border:none;cursor:pointer;box-shadow:0 4px 12px rgba(133,79,255,.3);z-index:999;transition:transform .3s;display:flex;align-items:center;justify-content:center}.n8n-chat-widget .chat-toggle.position-left{right:auto;left:20px}.n8n-chat-widget .chat-toggle:hover{transform:scale(1.05)}.n8n-chat-widget .chat-toggle svg{width:24px;height:24px;fill:currentColor}.n8n-chat-widget .chat-footer{padding:8px;text-align:center;background:var(--chat--color-background);border-top:1px solid rgba(133,79,255,.1)}.n8n-chat-widget .chat-footer a{color:var(--chat--color-primary);text-decoration:none;font-size:12px;opacity:.8;transition:opacity .2s;font-family:inherit}.n8n-chat-widget .chat-footer a:hover{opacity:1}.n8n-chat-widget .chat-message-container{display:flex;align-items:flex-end;gap:8px;max-width:90%}.n8n-chat-widget .chat-message-container.user{align-self:flex-end;flex-direction:row-reverse}.n8n-chat-widget .chat-message-container.bot{align-self:flex-start}.n8n-chat-widget .chat-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0}`;const fontLink=document.createElement("link");fontLink.rel="stylesheet",fontLink.href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-sans/style.css",document.head.appendChild(fontLink);const styleSheet=document.createElement("style");styleSheet.textContent=styles,document.head.appendChild(styleSheet);const defaultConfig={webhook:{url:"",route:""},branding:{logo:"",name:"",welcomeText:"",responseTimeText:"",poweredBy:{text:"Powered by n8n",link:"https://n8n.partnerlinks.io/m8a94i19zhqq?utm_source=nocodecreative.io"}},style:{primaryColor:"",secondaryColor:"",position:"right",backgroundColor:"#ffffff",fontColor:"#333333"}},config=window.ChatWidgetConfig?{webhook:{...defaultConfig.webhook,...window.ChatWidgetConfig.webhook},branding:{...defaultConfig.branding,...window.ChatWidgetConfig.branding,poweredBy:{...defaultConfig.branding.poweredBy,...window.ChatWidgetConfig.branding.poweredBy}},style:{...defaultConfig.style,...window.ChatWidgetConfig.style}}:defaultConfig;if(window.N8NChatWidgetInitialized)return;window.N8NChatWidgetInitialized=!0;let currentSessionId="";const widgetContainer=document.createElement("div");widgetContainer.className="n8n-chat-widget",widgetContainer.style.setProperty("--n8n-chat-primary-color",config.style.primaryColor),widgetContainer.style.setProperty("--n8n-chat-secondary-color",config.style.secondaryColor),widgetContainer.style.setProperty("--n8n-chat-background-color",config.style.backgroundColor),widgetContainer.style.setProperty("--n8n-chat-font-color",config.style.fontColor);const chatContainer=document.createElement("div");chatContainer.className=`chat-container${"left"===config.style.position?" position-left":""}`;const newConversationHTML=`\n        <div class="brand-header">\n            <img src="${config.branding.logo}" alt="${config.branding.name}">\n            <span>${config.branding.name}</span>\n            <button class="close-button">×</button>\n        </div>\n        <div class="new-conversation">\n            <h2 class="welcome-text">${config.branding.welcomeText}</h2>\n            <button class="new-chat-btn">\n                <svg class="message-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\n                    <path fill="currentColor" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.2L4 17.2V4h16v12z"/>\n                </svg>\n                Send us a message\n            </button>\n            <p class="response-text">${config.branding.responseTimeText}</p>\n        </div>\n    `,chatInterfaceHTML=`\n        <div class="chat-interface">\n            <div class="brand-header">\n                <img src="${config.branding.logo}" alt="${config.branding.name}">\n                <span>${config.branding.name}</span>\n                <button class="close-button">×</button>\n            </div>\n            <div class="chat-messages"></div>\n            <div class="chat-input">\n                <textarea placeholder="Type your message here..." rows="1"></textarea>\n                <button type="submit">Send</button>\n            </div>\n            <div class="chat-footer">\n                <a href="${config.branding.poweredBy.link}" target="_blank">${config.branding.poweredBy.text}</a>\n            </div>\n        </div>\n    `;chatContainer.innerHTML=newConversationHTML+chatInterfaceHTML;const toggleButton=document.createElement("button");config.branding.buttonIconUrl?(toggleButton.style.backgroundImage=`url('${config.branding.buttonIconUrl}')`,toggleButton.style.backgroundSize="cover",toggleButton.style.backgroundPosition="center"):toggleButton.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12c0 1.821.487 3.53 1.338 5L2.5 21.5l4.5-.838A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm0 18c-1.476 0-2.886-.313-4.156-.878l-3.156.586.586-3.156A7.962 7.962 0 014 12c0-4.411 3.589-8 8-8s8 3.589 8 8-3.589 8-8 8z"/></svg>',toggleButton.className=`chat-toggle${"left"===config.style.position?" position-left":""}`,widgetContainer.appendChild(chatContainer),widgetContainer.appendChild(toggleButton),document.body.appendChild(widgetContainer);const newChatBtn=chatContainer.querySelector(".new-chat-btn"),chatInterface=chatContainer.querySelector(".chat-interface"),messagesContainer=chatContainer.querySelector(".chat-messages"),textarea=chatContainer.querySelector("textarea"),sendButton=chatContainer.querySelector('button[type="submit"]');async function startNewConversation(){currentSessionId=crypto.randomUUID(),chatContainer.querySelector(".brand-header").style.display="none",chatContainer.querySelector(".new-conversation").style.display="none",chatInterface.classList.add("active"),config.branding.initialBotMessage&&(()=>{const e=document.createElement("div");e.className="chat-message-container bot";const t=document.createElement("img");t.className="chat-avatar",t.src=config.branding.botAvatarUrl||config.branding.logo;const n=document.createElement("div");n.className="chat-message bot",n.textContent=config.branding.initialBotMessage,e.appendChild(t),e.appendChild(n),messagesContainer.appendChild(e)})();const e=[{action:"loadPreviousSession",sessionId:currentSessionId,route:config.webhook.route,metadata:{userId:""}}];try{const t=await fetch(config.webhook.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await t.json(),s=document.createElement("div");s.className="chat-message-container bot";const o=document.createElement("img");o.className="chat-avatar",o.src=config.branding.botAvatarUrl||config.branding.logo;const a=document.createElement("div");a.className="chat-message bot",a.textContent=Array.isArray(n)?n[0].output:n.output,s.appendChild(o),s.appendChild(a),messagesContainer.appendChild(s),messagesContainer.scrollTop=messagesContainer.scrollHeight}catch(e){console.error("Error:",e)}}async function sendMessage(e){const t={action:"sendMessage",sessionId:currentSessionId,route:config.webhook.route,chatInput:e,metadata:{userId:""}},n=document.createElement("div");n.className="chat-message-container user";const s=document.createElement("div");s.className="chat-message user",s.textContent=e;const o=document.createElement("img");o.className="chat-avatar",o.src="https://www.svgrepo.com/show/532363/user-alt-1.svg",n.appendChild(s),n.appendChild(o),messagesContainer.appendChild(n),messagesContainer.scrollTop=messagesContainer.scrollHeight;try{const n=await fetch(config.webhook.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),s=await n.json(),o=document.createElement("div");o.className="chat-message-container bot";const a=document.createElement("img");a.className="chat-avatar",a.src=config.branding.botAvatarUrl||config.branding.logo;const r=document.createElement("div");r.className="chat-message bot",r.textContent=Array.isArray(s)?s[0].output:s.output,o.appendChild(a),o.appendChild(r),messagesContainer.appendChild(o),messagesContainer.scrollTop=messagesContainer.scrollHeight}catch(e){console.error("Error:",e)}}newChatBtn.addEventListener("click",startNewConversation),sendButton.addEventListener("click",(()=>{const e=textarea.value.trim();e&&(sendMessage(e),textarea.value="")})),textarea.addEventListener("keypress",(e=>{if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const t=textarea.value.trim();t&&(sendMessage(t),textarea.value="")}})),toggleButton.addEventListener("click",(()=>{chatContainer.classList.toggle("open")}));const closeButtons=chatContainer.querySelectorAll(".close-button");closeButtons.forEach((e=>{e.addEventListener("click",(()=>{chatContainer.classList.remove("open")}))}));
})();
